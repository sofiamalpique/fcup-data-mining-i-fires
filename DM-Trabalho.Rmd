---
title: "Untitled"
author: "Sofia Malpique"
date: "12/30/2021"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(dplyr)
library(dlookr)
library(rnoaa)
library(lubridate)
require(devtools)
library(zoo)
library(data.table)
library(ggplot2)
library(cluster)
library(fpc)
library(factoextra)
```


## Necessary libraries

Load necessary libraries

```{r echo = TRUE}
library(tidyverse)
library(dplyr)
library(dlookr)
library(rnoaa)
library(lubridate)
require(devtools)
library(zoo)
library(data.table)
library(ggplot2)
library(cluster)
library(fpc)
library(factoextra)
```

\newpage

## Data importing, cleaning and pre-processing

 Read the data

```{r}
fires_train <- read_csv("fires_train.csv", na=c("-","NA"))
```

First understanding of the data

```{r echo=TRUE}
fires_train
```
\newpage 
```{r echo=TRUE}
summary(fires_train)
```
\newpage
```{r echo=TRUE}
spec(fires_train)
```

## First diagnose of NA

```{r echo=TRUE}
fires_train %>% find_na(index=FALSE)
```
\newpage
```{r echo=TRUE}
fires_train %>% select(find_na(.)) %>% diagnose()
```

## Remove unnecessary columns and alert_source which has only Na as entry.

```{r echo=TRUE}
fires_train <- fires_train %>% select(-c(id,region,municipality,parish,
                                         alert_source,lat,lon,village_veget_area))
```

## Inspecting columns:

```{r echo=TRUE}
unique(select(fires_train,district))
```
\newpage  
We have a duplicate value: "Viana do Castelo" and "Viana Do Castelo".

```{r echo=TRUE}
fires_train <- fires_train %>% 
  mutate(district=replace(district,district=="Viana Do Castelo",
                                                       "Viana do Castelo"))
```

Now we are inspecting the different origins for the fire.

```{r echo=TRUE}
unique(select(fires_train,origin))
```

Get to know which ones were "false-alarm", because they don't matter.

```{r echo=TRUE}
fires_train %>% filter(origin=="false_alarm")
```

8 with false alarm and no area damage so we can remove them

```{r echo=TRUE}
fires_train <- fires_train %>% filter(origin!="false_alarm")
```

Given that "intentional_cause" is, in fact, a Boolean, it must be changed.

```{r echo=TRUE}
fires_train <- fires_train %>% mutate(district=as.factor(district), 
                                      origin=as.factor(origin), 
                                      intentional_cause=as.factor(intentional_cause))
```

Now we are interested in checking how many cases exist with "total_area"==0:

```{r echo=TRUE}
fires_train %>% filter(total_area==0)
```

We conclude that there's no cases with total_area==0.

Change date information into date format

```{r echo=TRUE}
fires_train <- fires_train %>% mutate(alert_date=as.Date(alert_date),
                    extinction_date=as.Date(extinction_date),
                    firstInterv_date=as.Date(firstInterv_date))
```

Second diagnose of NA.

```{r echo=TRUE}
fires_train %>% find_na(index=FALSE)
fires_train %>% select(find_na(.)) %>% diagnose()
fires_train %>% filter(!complete.cases(.))
```

We decided to keep the rows with NA in extinction_time and firstInterv_time, but just for now.

```{r echo=TRUE}
fires_train <- fires_train %>% select(-c(firstInterv_date,firstInterv_hour))
fires_train <- fires_train %>% drop_na()
```

So in order to merge another data set ("temp_data") with this one, and create a new one - called "final_data" - we needed to have something in common, which, in this case, is the district and the date of occurrence.

So we only have one question now: where did "temp_data" come from? What consists the "temp_data" data set?

## Collect the data with the temperature for each district

First load "station_data.Rdata".

```{r echo=TRUE}
load("station_data.Rdata")
```

We are only interested in he main-land of Portugal, that's why Azores and Madeira are not accounted. So we restrained to the coordinates of Portugal.

Also, we have element == "TMAX", because we are interested in using the maximum temperature registered on that day. We believe it influences the risk of natural fires, so it might help deciding the intentional cause.

```{r echo=TRUE}
station_data <- filter(station_data,str_starts(id,"PO"), latitude < 42.2,
                       latitude > 36.8, longitude > -9.6,longitude < -6.1,
                       element=="TMAX")
```

Now we select "id" and "name" because we want to check if there is any name duplicated.

```{r echo=TRUE}
station_data <- station_data %>% select(id,name)
```

We decided to remove "COIMBRA/CERNACHE" and "TAVIRA" because we are crossing districts and dates. "COIMBRA/CERNACHE" was removed because it already has "COIMBRA"- which is a district - and "TAVIRA" was removed because it isn't a district.

```{r echo=TRUE}
station_data <- station_data %>% filter(name!="COIMBRA/CERNACHE",name!="TAVIRA")

station_data <- station_data %>% filter(name!=is.na(name))
```

Here we restrained the dates. We're only interested in 2014 and 2015. All this information is going to a new data set called "weather_data".

```{r echo=TRUE}
weather_data <- ghcnd_search(station_data$id, var = c("TMAX"), 
                             date_min = "2014-01-01", date_max = "2015-12-31")
```

Here, the table is being copied to "weather_data".

```{r echo=TRUE}
weather_data <- weather_data$tmax
```

We maintain "id" so we are able to join tables later.

```{r echo=TRUE}
weather_data <- weather_data %>% select(id,tmax,date)
```

We sort first by id and then by date, so we guarantee to first search by district.

```{r echo=TRUE}
weather_data <- weather_data %>% arrange(id,date)
weather_data <- weather_data %>% fill(tmax)
```

Here we want to find out which stations in Portugal have data on tmax

```{r echo=TRUE}
merge(weather_data,station_data,"id") %>% distinct(id, .keep_all = TRUE) %>% 
  select(id,name)
```

As we don't have all the Portuguese districts in "station_data" we need to add/create a column called "nearest_district" containing the districts available in "weather_data".

With this we can put the values of maximum temperature to districts that don't appear in "weather_data" using the values of the nearest district.

```{r echo=TRUE}
station_data <- station_data %>% mutate(nearest_district=c("Lisboa","Porto",
                                                           "Coimbra","Beja",
                                                           "Bragança","Faro",
                                                           "Évora",
                                                           "Castelo Branco"))
station_data <- station_data %>% add_row(nearest_district="Viseu",
                                         id="PO000008575")
station_data <- station_data %>% add_row(nearest_district="Aveiro",
                                         id="PO000008575")
station_data <- station_data %>% add_row(nearest_district="Braga",
                                         id="PO000008575")
station_data <- station_data %>% add_row(nearest_district="Viana do Castelo",
                                         id="PO000008575")
station_data <- station_data %>% add_row(nearest_district="Vila Real", 
                                         id="PO000008575")
station_data <- station_data %>% add_row(nearest_district="Guarda", 
                                         id="POM00008570")
station_data <- station_data %>% add_row(nearest_district="Leiria", 
                                         id="PO000008535")
station_data <- station_data %>% add_row(nearest_district="Santarém", 
                                         id="PO000008535")
station_data <- station_data %>% add_row(nearest_district="Portalegre", 
                                         id="POM00008558")
station_data <- station_data %>% add_row(nearest_district="Setúbal", 
                                         id="PO000008535")
station_data$id[2] <- "PO000008575"
station_data$id[3] <- "POM00008570"
station_data$id[4] <- "POM00008558"
```

"temp_data" is a new table, created by merging "station_data" and "weather_data"

```{r echo=TRUE}
temp_data <- merge(station_data,weather_data,"id",all.x = TRUE)
temp_data <- as.tibble(temp_data)
temp_data <- temp_data %>% select(nearest_district,tmax,date)
temp_data <- temp_data %>% rename(district=nearest_district)
temp_data$tmax <- ((temp_data$tmax)/10)
```

"final_data" is a table with the original and relevant data adding the maximum temperature at the day of the fire. To merge temp_data and fires_train we rename alert_date to date so that we can match it according to this column

```{r echo=TRUE}
fires_train <- fires_train %>% mutate(date=alert_date)

final_data <- merge(temp_data,fires_train,c("district","date"), all.y = TRUE)
final_data <- as_tibble(final_data)
```

Observe if there are any Na that came with the merge

```{r echo=TRUE}
final_data %>% find_na(index=FALSE)
```

Creating a help dataset with all the rows where tmax is NA

```{r echo=TRUE}
help <- final_data %>% subset(is.na(tmax)) %>% 
  select(district,date,tmax)
```

Add the rows to the temp_data where there are no rows with missing NA and order it by district and date so that we can fill the tmax that is missing with the previous tmax value

```{r echo=TRUE}
temp_data <- temp_data %>% add_row(help) %>% 
  arrange(district,date) %>% 
  fill(tmax)
```

Drop dublicated rows

```{r echo=TRUE}
temp_data <- unique(temp_data)
```

Now temp_data has temperatures for all dates in fires train so we merge again the two datasets

```{r echo=TRUE}
final_data <- final_data %>% select(-c(tmax))
final_data <- merge(temp_data,final_data,c("district","date"))
final_data <- as_tibble(final_data)

```

We think it might be useful to have the season as a variable. In order to do that, we've created the following function, so it converts a date into the corresponding season.

```{r echo=TRUE}
final_data <- final_data %>% rename(season = date)

getSeason <- function(DATES) {
  WS <- as.Date("2012-12-21", format = "%Y-%m-%d") # Winter Solstice
  SE <- as.Date("2012-3-21",  format = "%Y-%m-%d") # Spring Equinox
  SS <- as.Date("2012-6-21",  format = "%Y-%m-%d") # Summer Solstice
  FE <- as.Date("2012-9-23",  format = "%Y-%m-%d") # Fall Equinox
  
  # Convert dates from any year to 2012 dates
  d <- as.Date(strftime(DATES, format="2012-%m-%d"))
  
  ifelse (d >= WS | d < SE, "Winter",
          ifelse (d >= SE & d < SS, "Spring",
                  ifelse (d >= SS & d < FE, "Summer", "Fall")))
}

final_data$season <- getSeason(final_data$season)

final_data <- final_data %>% mutate(season = as.factor(season))
```

##Data exploratory analysis

```{r echo=TRUE}
summary(final_data)
```

How many intentional and non intentional fires do we have?

```{r echo=TRUE}
final_data %>% group_by(intentional_cause) %>% count()
ggplot(final_data, aes(x=intentional_cause)) + geom_bar() +
  ggtitle("How many fires were intentional and non-intentional?")

```

What's the distribution of the fires according to the season?

```{r echo=TRUE}
ggplot(final_data, aes(x=season)) + geom_bar() + facet_wrap(~intentional_cause) +
  ggtitle("Relationship between season and intentional cause")
```

Could there be a relationship between "intentional_cause" and the maximum temperature?

```{r echo=TRUE}
ggplot(final_data, aes(x=tmax)) + geom_histogram(binwidth = 2) + 
  facet_wrap(~intentional_cause) + 
  ggtitle("Relationship between maximum temperature and intentional cause")
```

Could there be a relationship between "intentional_cause" and the time it was alerted?

```{r echo=TRUE}
ggplot(final_data, aes(x=as.ITime(alert_hour))) + geom_histogram(binwidth = 3600) + 
  scale_x_time() + facet_wrap(~intentional_cause)
```

What can we say about the "origin" and the "intentional_cause"?

```{r echo=TRUE}
final_data %>% group_by(origin,intentional_cause) %>% count() %>% 
  arrange(desc(n))

ggplot(final_data, aes(x=intentional_cause)) + geom_bar() + facet_wrap(~origin)
```

We can see in the graph that the most fires with "intentional_cause" have origin "firepit".

Relationship between "tmax", "origin" and "intentional_cause"

```{r echo=TRUE}
ggplot(final_data, aes(x=tmax)) + geom_histogram(binwidth = 2) + 
  facet_grid(intentional_cause~origin)
```

Is there a relationship between the area damaged and intentional_cause?

```{r echo=TRUE}
final_data %>% group_by(intentional_cause) %>% 
  summarise(total_area_mean=mean(total_area), 
            total_area_median=median(total_area))

ggplot(final_data, aes(x=village_area)) + geom_histogram(binwidth = 200) + 
  facet_wrap(~intentional_cause)

ggplot(final_data, aes(x=vegetation_area)) + geom_histogram(binwidth = 200) + 
  facet_wrap(~intentional_cause)

ggplot(final_data, aes(x=farming_area)) + geom_histogram(binwidth = 200) + 
  facet_wrap(~intentional_cause)

ggplot(final_data, aes(x=total_area)) + geom_histogram(binwidth = 200) + 
  facet_wrap(~intentional_cause)
```

What is the correlation coefficient between all numeric attributes?

```{r echo=TRUE}
final_data %>% select(tmax,village_area, farming_area, 
                 vegetation_area, total_area) %>% cor()
```

Is there any monotonic relationship?

```{r echo=TRUE}
final_data %>% select(tmax,village_area, farming_area, 
                 vegetation_area, total_area) %>% cor(method = "spearman")
```

##Clustering

In order to Clustering we need to pass to the new data set (called "data_cluster") the relevant attributes.

We believe the relevant attributes are "tmax", "village_area", "vegetation_area" and "farming_area". Note that we didn't include "total_area" because it is a linear combination of the last 3 attributes mentioned above.

```{r echo=TRUE}
data_cluster <- final_data %>% select(tmax,village_area,vegetation_area,
                                      farming_area)
```

Given that the data has different scales, we decided to use the scale() function:

```{r echo=TRUE}
data_cluster.scale <- data_cluster %>% mutate_all(scale)
```

### K-MEANS Algorithm

Calculating the optimal number of cluster (k) through silhouette method and also plotting the result:

```{r echo=TRUE}
fviz_nbclust(data_cluster.scale, kmeans, method = "silhouette")
```

We got k=3 as the optimal number of clusters.

Now we'll perform K-means algorithm with k=3:

```{r echo=TRUE}
k3 <- kmeans(data_cluster.scale, centers=3)
```

Plotting the clusters:

```{r echo=TRUE}
fviz_cluster(k3, data_cluster.scale)
```

\`\`\`
